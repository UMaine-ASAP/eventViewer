<div class="page-header"><h1>Events <small>Quantifiable changes localized in spacetime</small></h1></div>
<div class="well">
<script>

$(document).ready(function() {

	var dataString = "method=relation";
	EventViewer.query(dataString, function(data) {
		//console.log(data);
		build_containers(data);
	});
});

function build_containers(data){

$.each(data, function(key, value){
	$('#events_container').append('<h3 id="' + key + '"><a href="#">'+ key + ' - ' + value + '</a></h3><div id="options_container" class="' + key + '"><div class="event_col1"></div><div class="event_col2"></div><div class="event_col3"></div><div class="event_col4"></div></div>');
})

$("#events_container").accordion({
	active: false,
	collapsible: true,
	create: function(event, ui){
		$(this).accordion("activate", 0);
	},
	change: function(event, ui){

		var clicked = $(this).find('.ui-state-active').attr('id');

		if($("div." + clicked).children('.event_col1').html() == "") {
			var dataString = "method=meta&relation="+ clicked;
			var value_id = clicked + "_id";

			$.ajax({
				type: "GET",
				url: "get.php",
				data: dataString,
				success: function(data) {

					var count = Math.floor((data.length)/4);
					var col = 1;
					
					//DEBUG
					//console.log(data);
					

					$.each(data, function(key, value){
						var div = $("div." + clicked).children('.event_col' + col).append('<li style="padding: 3px;" class="' + clicked +'" id="' + value[clicked + "_id"] + '"> <button class="btn btn-mini constraint" href=""><i class="icon-plus"></i></button> ' + value.name + '</input></li>');

						col++;
						if(col > 4){
							col = 1;
						}
					})

					checkBoxes(queryView.collection.toJSON(), clicked);
						
						$(".constraint").click(function() {
							if($(this).hasClass("btn-danger")){
        						queryView.removeConstraint($(this).parent().attr("id"), $(this).parent().text());
        						$(this).removeClass("btn-danger").children("i").toggleClass('icon-minus icon-plus');
        					}
        					else {
        						queryView.addConstraint($(this).parent().attr("id"), clicked, $(this).parent().text(), "event");
        						$(this).addClass("btn-danger").children("i").toggleClass('icon-plus icon-minus');
        					}
    					});

				}
			})
		}
		else{
		console.log(clicked);
		}

	}
});
}

function checkBoxes(checked, section){
	$.each(checked, function(key, value){
		if(value.id_type == section){
			$("div." + section).find("li#" + value.id_value).children(".constraint").addClass("btn-danger").children("i").toggleClass('icon-plus icon-minus');
		}
	});
}
</script>

<div id="events_container"></div>
</div>